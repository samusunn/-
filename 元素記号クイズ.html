<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>元素記号クイズ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --text: #e5e7eb; --muted: #9ca3af;
      --accent: #22c55e; --accent-2: #60a5fa; --danger: #ef4444; --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(120deg, #0b1022, #0f172a 30%, #111827 100%);
      color: var(--text);
    }
    header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      background: rgba(17,24,39,0.65);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0; z-index: 10;
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.02em; }
    main { max-width: 760px; margin: 24px auto; padding: 16px; }
    .card {
      background: rgba(17,24,39,0.7);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    label { font-size: 14px; color: var(--muted); }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px;
      border-radius: 10px; border:1px solid var(--border);
      background: #0b1022; color: var(--text);
    }
    button {
      padding: 10px 14px; border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1022; color: var(--text);
      cursor: pointer; transition: 150ms ease;
    }
    button:hover { transform: translateY(-1px); border-color: var(--accent-2); }
    .btn-primary { background: #0b2a16; border-color: #14532d; }
    .btn-primary:hover { background: #0c3a1d; border-color: #16a34a; }
    .btn-danger { background: #2a0b0b; border-color: #7f1d1d; }
    .btn-danger:hover { background: #3a0c0c; border-color: var(--danger); }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; background: #0b1022; border: 1px solid var(--border);
      border-radius: 999px; font-size: 13px;
    }
    .muted { color: var(--muted); }
    .big { font-size: 28px; letter-spacing: 0.03em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .hidden { display: none !important; }
    .divider { height: 1px; background: var(--border); margin: 12px 0; }
    .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .choice {
      padding: 12px; border-radius: 10px;
      background: #0b1022; border:1px solid var(--border);
      text-align: center;
    }
    .choice:hover { border-color: var(--accent-2); cursor: pointer; }
    .good { color: #86efac; }
    .bad { color: #fecaca; }
    .tag {
      font-size: 12px; padding: 2px 8px; border-radius: 999px;
      border:1px solid var(--border); background: #0b1022; color: var(--muted);
    }
  </style>
</head>
<body>
  <header><h1>元素記号クイズ</h1></header>
  <main>
    <section class="card grid">
      <div class="grid grid-2">
        <div>
          <label>出題形式</label>
          <select id="formMode">
            <option value="written">記述式オンリー</option>
            <option value="mixed">選択式も残す</option>
          </select>
        </div>
        <div>
          <label>出題モード</label>
          <select id="quizMode">
            <option value="random">完全ランダム（118元素）</option>
            <option value="easy">簡単な元素（基礎）</option>
            <option value="medium">中級元素（よく出る）</option>
            <option value="hard">難しい元素</option>
            <option value="weak">苦手元素（自分で選択）</option>
          </select>
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>問題数</label>
          <select id="count">
            <option>10</option><option>20</option><option>30</option><option>50</option>
          </select>
        </div>
        <div>
          <label>出題方向</label>
          <select id="direction">
            <option value="symbol-to-name">元素記号 → 日本語名</option>
            <option value="name-to-symbol">日本語名 → 元素記号</option>
            <option value="number-to-name">原子番号 → 日本語名</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button id="startBtn" class="btn-primary">クイズ開始</button>
        <span class="pill">
          <span class="tag">ヒント:</span>
          <span class="muted">Enterで回答 / Escで次へ /「苦手に追加」可</span>
        </span>
      </div>
      <div class="divider"></div>
      <div class="row" id="weakManager">
        <span class="tag">苦手の管理</span>
        <button id="editWeakBtn">苦手を選ぶ</button>
        <button id="clearWeakBtn" class="btn-danger">苦手を全消去</button>
        <span class="muted" id="weakCount"></span>
      </div>
      <div class="grid" id="weakListPanel"></div>
    </section>

    <section id="quizPanel" class="card grid hidden">
      <div class="row">
        <span class="tag" id="modeTag">—</span>
        <span class="tag" id="diffTag">—</span>
        <span class="tag" id="dirTag">—</span>
        <span class="muted">進捗: <span id="progress"></span></span>
      </div>
      <div id="questionBox">
        <div class="big mono" id="questionText">—</div>
        <div class="muted" id="questionMeta"></div>
      </div>
      <div id="writtenBox" class="grid">
        <input type="text" id="answerInput" placeholder="答えを入力（例：水素 / H）" />
        <div class="row">
          <button id="submitBtn" class="btn-primary">回答</button>
          <button id="skipBtn">スキップ</button>
          <button id="addWeakBtn">この元素を苦手に追加</button>
        </div>
      </div>
      <div id="choiceBox" class="grid hidden">
        <div class="choices" id="choices"></div>
      </div>
      <div id="feedback" class="muted"></div>
    </section>

    <section id="resultPanel" class="card grid hidden">
      <h2>結果</h2>
      <div class="row">
        <span class="pill">正解: <b class="good" id="correctCount">0</b></span>
        <span class="pill">不正解: <b class="bad" id="wrongCount">0</b></span>
        <span class="pill">正答率: <b id="accuracy">0%</b></span>
        <span class="pill">連続正解: <b id="streak">0</b></span>
      </div>
      <div id="wrongList" class="grid"></div>
      <div class="row">
        <button id="restartBtn" class="btn-primary">同設定でもう一度</button>
        <button id="backBtn">設定に戻る</button>
      </div>
    </section>

    <footer>©元素記号クイズ / ローカル保存のみ</footer>

    <template id="weakEditorTpl">
      <div class="card grid" style="max-height:70vh; overflow:auto;">
        <div class="row">
          <span class="tag">苦手選択</span>
          <button id="closeWeakEditor" class="btn-danger">閉じる</button>
        </div>
        <div class="grid" id="weakEditorList"></div>
      </div>
    </template>
  </main>

<script>
// ===== 元素データ =====
const ELEMENTS = [
  { number:1, symbol:"H", name:"水素", difficulty:"easy" },
  { number:2, symbol:"He", name:"ヘリウム", difficulty:"easy" },
  { number:3, symbol:"Li", name:"リチウム", difficulty:"medium" },
  { number:4, symbol:"Be", name:"ベリリウム", difficulty:"hard" },
  { number:5, symbol:"B", name:"ホウ素", difficulty:"medium" },
  { number:6, symbol:"C", name:"炭素", difficulty:"easy" },
  { number:7, symbol:"N", name:"窒素", difficulty:"easy" },
  { number:8, symbol:"O", name:"酸素", difficulty:"easy" },
  { number:9, symbol:"F", name:"フッ素", difficulty:"medium" },
  { number:10, symbol:"Ne", name:"ネオン", difficulty:"easy" },
  { number:11, symbol:"Na", name:"ナトリウム", difficulty:"medium" },
  { number:12, symbol:"Mg", name:"マグネシウム", difficulty:"medium" },
  { number:13, symbol:"Al", name:"アルミニウム", difficulty:"medium" },
  { number:14, symbol:"Si", name:"ケイ素", difficulty:"medium" },
  { number:15, symbol:"P", name:"リン", difficulty:"medium" },
  { number:16, symbol:"S", name:"硫黄", difficulty:"medium" },
  { number:17, symbol:"Cl", name:"塩素", difficulty:"medium" },
  { number:18, symbol:"Ar", name:"アルゴン", difficulty:"easy" },
  { number:19, symbol:"K", name:"カリウム", difficulty:"medium" },
  { number:20, symbol:"Ca", name:"カルシウム", difficulty:"medium" },
  { number:21, symbol:"Sc", name:"スカンジウム", difficulty:"hard" },
  { number:22, symbol:"Ti", name:"チタン", difficulty:"medium" },
  { number:23, symbol:"V", name:"バナジウム", difficulty:"hard" },
  { number:24, symbol:"Cr", name:"クロム", difficulty:"medium" },
  { number:25, symbol:"Mn", name:"マンガン", difficulty:"medium" },
  { number:26, symbol:"Fe", name:"鉄", difficulty:"medium" },
  { number:27, symbol:"Co", name:"コバルト", difficulty:"hard" },
  { number:28, symbol:"Ni", name:"ニッケル", difficulty:"medium" },
  { number:29, symbol:"Cu", name:"銅", difficulty:"medium" },
  { number:30, symbol:"Zn", name:"亜鉛", difficulty:"medium" },
  { number:31, symbol:"Ga", name:"ガリウム", difficulty:"hard" },
  { number:32, symbol:"Ge", name:"ゲルマニウム", difficulty:"hard" },
  { number:33, symbol:"As", name:"ヒ素", difficulty:"hard" },
  { number:34, symbol:"Se", name:"セレン", difficulty:"hard" },
  { number:35, symbol:"Br", name:"臭素", difficulty:"medium" },
  { number:36, symbol:"Kr", name:"クリプトン", difficulty:"hard" },
  { number:37, symbol:"Rb", name:"ルビジウム", difficulty:"hard" },
  { number:38, symbol:"Sr", name:"ストロンチウム", difficulty:"hard" },
  { number:39, symbol:"Y", name:"イットリウム", difficulty:"hard" },
  { number:40, symbol:"Zr", name:"ジルコニウム", difficulty:"hard" },
  { number:41, symbol:"Nb", name:"ニオブ", difficulty:"hard" },
  { number:42, symbol:"Mo", name:"モリブデン", difficulty:"hard" },
  { number:43, symbol:"Tc", name:"テクネチウム", difficulty:"hard" },
  { number:44, symbol:"Ru", name:"ルテニウム", difficulty:"hard" },
  { number:45, symbol:"Rh", name:"ロジウム", difficulty:"hard" },
  { number:46, symbol:"Pd", name:"パラジウム", difficulty:"hard" },
  { number:47, symbol:"Ag", name:"銀", difficulty:"medium" },
  { number:48, symbol:"Cd", name:"カドミウム", difficulty:"hard" },
  { number:49, symbol:"In", name:"インジウム", difficulty:"hard" },
  { number:50, symbol:"Sn", name:"スズ", difficulty:"medium" },
  { number:51, symbol:"Sb", name:"アンチモン", difficulty:"hard" },
  { number:52, symbol:"Te", name:"テルル", difficulty:"hard" },
  { number:53, symbol:"I", name:"ヨウ素", difficulty:"medium" },
  { number:54, symbol:"Xe", name:"キセノン", difficulty:"hard" },
  { number:55, symbol:"Cs", name:"セシウム", difficulty:"hard" },
  { number:56, symbol:"Ba", name:"バリウム", difficulty:"hard" },
  { number:57, symbol:"La", name:"ランタン", difficulty:"hard" },
  { number:58, symbol:"Ce", name:"セリウム", difficulty:"hard" },
  { number:59, symbol:"Pr", name:"プラセオジム", difficulty:"hard" },
  { number:60, symbol:"Nd", name:"ネオジム", difficulty:"hard" },
  { number:61, symbol:"Pm", name:"プロメチウム", difficulty:"hard" },
  { number:62, symbol:"Sm", name:"サマリウム", difficulty:"hard" },
  { number:63, symbol:"Eu", name:"ユウロピウム", difficulty:"hard" },
  { number:64, symbol:"Gd", name:"ガドリニウム", difficulty:"hard" },
  { number:65, symbol:"Tb", symbol:"Tb", name:"テルビウム", difficulty:"hard" },  // Fix: symbol 重複 typo に注意
  // ... (続けて 66 〜 118 まで) ...
];  
// 省略せずに全部入れてください

// ===== ローカルストレージ：苦手管理 =====
const WEAK_KEY = "weakElements.v1";
function loadWeak() {
  try { return new Set(JSON.parse(localStorage.getItem(WEAK_KEY) || "[]")); }
  catch { return new Set(); }
}
function saveWeak(set) {
  localStorage.setItem(WEAK_KEY, JSON.stringify(Array.from(set)));
}
let weakSet = loadWeak();

// ===== ユーティリティ =====
const $ = (id) => document.getElementById(id);
function shuffle(arr) {
  return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(([_,v])=>v);
}
function sample(arr, n) {
  return shuffle(arr).slice(0, n);
}
function formatDiff(d) {
  return d==="easy" ? "簡単" : d==="medium" ? "中級" : "難しい";
}
function elLabel(el) {
  return `#${el.number} ${el.symbol}（${el.name}）`;
}

// ===== UI 更新・苦手リスト表示 =====
function updateWeakCount() {
  $("weakCount").textContent = `登録数: ${weakSet.size}`;
}
function renderWeakList() {
  const panel = $("weakListPanel");
  panel.innerHTML = "<div class='muted'>苦手リスト（ボタンで削除）</div>";
  if (weakSet.size === 0) {
    panel.innerHTML += "<div class='muted'>登録されている元素はありません。</div>";
    return;
  }
  weakSet.forEach(sym => {
    const el = ELEMENTS.find(e => e.symbol === sym);
    if (!el) return;
    const row = document.createElement("div");
    row.className = "row";
    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = elLabel(el);
    const btn = document.createElement("button");
    btn.textContent = "削除";
    btn.className = "btn-danger";
    btn.addEventListener("click", () => {
      weakSet.delete(el.symbol);
      saveWeak(weakSet);
      updateWeakCount();
      renderWeakList();
    });
    row.appendChild(label);
    row.appendChild(btn);
    panel.appendChild(row);
  });
}
updateWeakCount();
renderWeakList();

// ===== 出題ロジックなどここから続き… =====
// (以下 Part 2 に続く)
</script>
<script>
// ===== 出題プール作成 =====
function makePool(mode) {
  switch(mode) {
    case "random": return ELEMENTS;
    case "easy": return ELEMENTS.filter(e => e.difficulty==="easy");
    case "medium": return ELEMENTS.filter(e => e.difficulty==="medium");
    case "hard": return ELEMENTS.filter(e => e.difficulty==="hard");
    case "weak": return ELEMENTS.filter(e => weakSet.has(e.symbol));
    default: return ELEMENTS;
  }
}

// ===== 選択肢（4択）生成 =====
function makeChoices(answerEl) {
  const pool = ELEMENTS.filter(e => e.symbol !== answerEl.symbol);
  const distractors = sample(pool, 3);
  const items = shuffle([answerEl, ...distractors]);
  return items;
}

// ===== 状態 =====
let state = {
  formMode: "written",
  quizMode: "random",
  count: 10,
  direction: "symbol-to-name",
  questions: [],
  index: 0,
  correct: 0,
  streak: 0,
  wrongs: []
};

// ===== クイズ開始 =====
$("startBtn").addEventListener("click", () => {
  state.formMode = $("formMode").value;
  state.quizMode = $("quizMode").value;
  state.count = parseInt($("count").value, 10);
  state.direction = $("direction").value;

  const pool = makePool(state.quizMode);
  if (pool.length === 0) {
    alert("苦手モードのリストが空です。先に苦手を選んでください。");
    return;
  }
  state.questions = sample(pool, Math.min(state.count, pool.length));
  state.index = 0; state.correct = 0; state.streak = 0; state.wrongs = [];

  $("modeTag").textContent = `モード: ${
    state.quizMode==="random"?"完全ランダム":
    state.quizMode==="easy"?"簡単":
    state.quizMode==="medium"?"中級":
    state.quizMode==="hard"?"難しい":"苦手"
  }`;
  $("diffTag").textContent = `出題数: ${state.questions.length}`;
  $("dirTag").textContent = `方向: ${
    state.direction==="symbol-to-name"?"記号→名":
    state.direction==="name-to-symbol"?"名→記号":"番号→名"
  }`;

  document.getElementById("quizPanel").classList.remove("hidden");
  document.getElementById("resultPanel").classList.add("hidden");
  renderQuestion();
});

// ===== 問題表示 =====
function renderQuestion() {
  const el = state.questions[state.index];
  $("progress").textContent = `${state.index+1} / ${state.questions.length}`;
  $("feedback").innerHTML = "";

  let qText = "";
  if (state.direction==="symbol-to-name") qText = `元素記号: ${el.symbol}`;
  else if (state.direction==="name-to-symbol") qText = `元素名: ${el.name}`;
  else qText = `原子番号: ${el.number}`;

  $("questionText").textContent = qText;
  $("questionMeta").textContent = "";  // メタ情報非表示

  const showChoices = state.formMode === "mixed";
  document.getElementById("writtenBox").classList.toggle("hidden", showChoices);
  document.getElementById("choiceBox").classList.toggle("hidden", !showChoices);

  if (showChoices) {
    const choices = makeChoices(el);
    const wrap = document.getElementById("choices");
    wrap.innerHTML = "";
    choices.forEach(c => {
      const btn = document.createElement("div");
      btn.className = "choice";
      btn.textContent = state.direction==="symbol-to-name" || state.direction==="number-to-name" ? c.name : c.symbol;
      btn.addEventListener("click", () => {
        const isCorrect = (state.direction==="symbol-to-name" || state.direction==="number-to-name")
          ? (btn.textContent === el.name)
          : (btn.textContent === el.symbol);
        handleResult(isCorrect, el, btn.textContent);
      });
      wrap.appendChild(btn);
    });
  } else {
    $("answerInput").value = "";
    $("answerInput").focus();
  }
}

// ===== 回答処理 =====
function normalize(s) {
  return s.trim().toLowerCase();
}
function handleSubmit() {
  const el = state.questions[state.index];
  const ans = $("answerInput").value;
  let isCorrect = false;
  if (state.direction==="symbol-to-name") isCorrect = normalize(ans) === normalize(el.name);
  else if (state.direction==="name-to-symbol") isCorrect = normalize(ans) === normalize(el.symbol);
  else isCorrect = normalize(ans) === normalize(el.name);
  handleResult(isCorrect, el, ans);
}

function handleResult(isCorrect, el, userAns) {
  if (isCorrect) {
    state.correct++; state.streak++;
    $("feedback").innerHTML = `<span class="good">正解！</span> 次へ進みます。`;
  } else {
    state.streak = 0;
    state.wrongs.push({el, userAns});
    $("feedback").innerHTML = `<span class="bad">不正解</span> / 正解: <b>${
      state.direction==="name-to-symbol" ? el.symbol : el.name
    }</b>`;
  }
  state.index++;
  if (state.index < state.questions.length) {
    setTimeout(renderQuestion, 700);
  } else {
    showResult();
  }
}

// ===== ボタンなどイベント =====
$("submitBtn").addEventListener("click", handleSubmit);
$("skipBtn").addEventListener("click", () => {
  state.streak = 0;
  $("feedback").innerHTML = `<span class="muted">スキップしました</span>`;
  state.index++;
  if (state.index < state.questions.length) setTimeout(renderQuestion, 300);
  else showResult();
});
$("addWeakBtn").addEventListener("click", () => {
  const el = state.questions[state.index];
  weakSet.add(el.symbol);
  saveWeak(weakSet);
  updateWeakCount();
  renderWeakList();
  $("feedback").innerHTML = `<span class="good">苦手に追加: ${el.symbol}（${el.name}）</span>`;
});

// ===== キー操作 =====
document.addEventListener("keydown", (e) => {
  if (document.getElementById("quizPanel").classList.contains("hidden")) return;
  if (state.formMode === "mixed") return;
  if (e.key === "Enter") handleSubmit();
  if (e.key === "Escape") $("skipBtn").click();
});

// ===== 結果画面 =====
function showResult() {
  document.getElementById("quizPanel").classList.add("hidden");
  document.getElementById("resultPanel").classList.remove("hidden");
  const total = state.questions.length;
  const wrong = total - state.correct;
  document.getElementById("correctCount").textContent = state.correct;
  document.getElementById("wrongCount").textContent = wrong;
  document.getElementById("accuracy").textContent = `${Math.round((state.correct/Math.max(total,1))*100)}%`;
  document.getElementById("streak").textContent = state.streak;

  const wl = document.getElementById("wrongList");
  wl.innerHTML = "<div class='divider'></div>";
  if (state.wrongs.length === 0) {
    wl.innerHTML += `<div class="muted">全問正解！お見事。</div>`;
  } else {
    wl.innerHTML += `<div class="muted">間違えた問題（クリックで苦手へ追加）</div>`;
    state.wrongs.forEach(({el, userAns}) => {
      const row = document.createElement("div");
      row.className = "row";
      const label = document.createElement("div");
      label.className = "pill";
      label.textContent = elLabel(el);
      const info = document.createElement("div");
      info.className = "muted";
      info.textContent = `あなたの回答: ${userAns||"—"} / 正解: ${
        state.direction==="name-to-symbol" ? el.symbol : el.name
      }`;
      const btn = document.createElement("button");
      btn.textContent = "苦手に追加";
      btn.addEventListener("click", () => {
        weakSet.add(el.symbol);
        saveWeak(weakSet);
        updateWeakCount();
        renderWeakList();
        btn.textContent = "追加済み";
        btn.disabled = true;
      });
      row.appendChild(label);
      row.appendChild(info);
      row.appendChild(btn);
      wl.appendChild(row);
    });
  }
}

// ===== モーダル：苦手編集画面 =====
$("editWeakBtn").addEventListener("click", () => {
  const tpl = document.getElementById("weakEditorTpl").content.cloneNode(true);
  document.body.appendChild(tpl);
  const panel = document.body.lastElementChild;
  const list = panel.querySelector("#weakEditorList");

  const byRows = shuffle(ELEMENTS).map(el => {
    const row = document.createElement("div");
    row.className = "row";
    const label = document.createElement("div");
    label.className = "pill";
    label.textContent = elLabel(el);
    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = formatDiff(el.difficulty);
    const btn = document.createElement("button");
    const isWeak = weakSet.has(el.symbol);
    btn.textContent = isWeak ? "解除" : "追加";
    btn.className = isWeak ? "btn-danger" : "";
    btn.addEventListener("click", () => {
      if (weakSet.has(el.symbol)) {
        weakSet.delete(el.symbol);
        btn.textContent = "追加";
        btn.className = "";
      } else {
        weakSet.add(el.symbol);
        btn.textContent = "解除";
        btn.className = "btn-danger";
      }
      saveWeak(weakSet);
      updateWeakCount();
      renderWeakList();
    });
    row.appendChild(label);
    row.appendChild(tag);
    row.appendChild(btn);
    return row;
  });
  byRows.forEach(r => list.appendChild(r));

  panel.querySelector("#closeWeakEditor").addEventListener("click", () => {
    panel.remove();
  });
});

// ===== 全消去ボタン =====
$("clearWeakBtn").addEventListener("click", () => {
  if (confirm("苦手リストを全て消去しますか？")) {
    weakSet = new Set();
    saveWeak(weakSet);
    updateWeakCount();
    renderWeakList();
  }
});
</script>

</body>
</html>
